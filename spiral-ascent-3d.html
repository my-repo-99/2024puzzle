<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiral Ascent 3D</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div id="info">
        <div id="score">Score: 0</div>
        <div id="highscore">High Score: 0</div>
        <div id="instructions">A/D or ←/→: Move | Space: Jump | R: Restart</div>
    </div>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.165.0/build/three.module.js"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';

        let scene, camera, renderer, player, stairs, clock, particleSystem, starfield, audioListener, jumpSound, landSound, gameOverSound;
        let score = 0;
        let highScore = 0;

        let playerVelocity = new THREE.Vector3();
        const keys = {};
        let raycaster = new THREE.Raycaster();
        
        let speedBoost = 0;
        let slowEffect = 0;
        let iceEffect = 0;

        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);

        let lastStairGenerated = 0;

        function init() {
            // Scene
            scene = new THREE.Scene();
            clock = new THREE.Clock();

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            // Stairs
            stairs = new THREE.Group();
            scene.add(stairs);
            generateStairs(200, 0); // Generate initial stairs
            lastStairGenerated = 200;

            // Player
            const playerGeometry = new THREE.BoxGeometry(1, 1, 1);
            const playerMaterial = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
            player = new THREE.Mesh(playerGeometry, playerMaterial);
            player.position.y = 0.5;
            player.position.x = 5; // Start on the first step
            scene.add(player);

            // Initial animation call
            animate();

            // Load high score
            highScore = localStorage.getItem('spiralAscentHighScore') || 0;
            document.getElementById('highscore').innerText = `High Score: ${highScore}`;

            // Audio
            audioListener = new THREE.AudioListener();
            camera.add(audioListener);
        }

        function playSound(type, frequency, duration) {
            if (!audioListener) return;
            const audioContext = audioListener.context;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioListener.getInput());

            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        let gameOver = false;
        let wasOnGround = false;

        function animate() {
            requestAnimationFrame(animate);

            if (gameOver) {
                if (keys['KeyR']) {
                    restartGame();
                }
                return; // Stop updates if game is over
            }

            const delta = clock.getDelta();
            let moveSpeed = 5;
            const jumpStrength = 7;
            const gravity = -20;
            
            // Update effects
            if (speedBoost > 0) {
                speedBoost -= delta;
                moveSpeed *= 2;
            }
            if (slowEffect > 0) {
                slowEffect -= delta;
                moveSpeed *= 0.5;
            }
            if (iceEffect > 0) {
                iceEffect -= delta;
            }

            // Apply gravity
            playerVelocity.y += gravity * delta;
            player.position.y += playerVelocity.y * delta;

            // Collision detection
            raycaster.set(player.position, new THREE.Vector3(0, -1, 0));
            const intersects = raycaster.intersectObjects(stairs.children);
            let onGround = false;

            if (intersects.length > 0) {
                const groundObject = intersects[0].object;
                const groundHeight = groundObject.position.y + 0.1; // 0.1 is half the step height

                if (player.position.y - 0.5 < groundHeight && playerVelocity.y <= 0) {
                    player.position.y = groundHeight + 0.5;
                    playerVelocity.y = 0;
                    onGround = true;

                    if (!wasOnGround) {
                        playSound('sine', 220, 0.1);
                    }

                    // Check for special tile effects
                    const tileColor = groundObject.material.color.getHex();
                    if (tileColor === 0x00ff88) { // Green spring tile
                        playerVelocity.y = jumpStrength * 3; // Much stronger spring effect - can reach next level
                        playSound('triangle', 660, 0.3); // Higher pitch sound
                    } else if (tileColor === 0xffff00) { // Yellow speed boost tile
                        speedBoost = 3; // 3 seconds of speed boost
                        playSound('sine', 880, 0.2);
                    } else if (tileColor === 0x8800ff) { // Purple slow tile
                        slowEffect = 3; // 3 seconds of slow effect
                        playSound('sine', 110, 0.2);
                    } else if (tileColor === 0x00ffff) { // Cyan ice tile
                        iceEffect = 5; // 5 seconds of ice effect
                        playSound('triangle', 1320, 0.15);
                    }
                }
            }

            // Player angle on the spiral
            let playerAngle = Math.atan2(player.position.z, player.position.x);
            const playerRadius = 5; // Keep a constant radius

            // Player controls
            let angleChange = 0;
            if (keys['KeyA'] || keys['ArrowLeft']) {
                angleChange -= moveSpeed * delta / playerRadius;
            }
            if (keys['KeyD'] || keys['ArrowRight']) {
                angleChange += moveSpeed * delta / playerRadius;
            }
            
            if (iceEffect > 0) {
                // Ice effect - sliding momentum
                if (Math.abs(angleChange) > 0) {
                    playerAngle += angleChange * 1.5; // More sliding
                }
            } else {
                playerAngle += angleChange;
            }
            if (keys['Space'] && onGround) {
                playerVelocity.y = jumpStrength;
                playSound('triangle', 440, 0.2);
            }

            player.position.x = Math.cos(playerAngle) * playerRadius;
            player.position.z = Math.sin(playerAngle) * playerRadius;
            player.rotation.y = -playerAngle + Math.PI / 2;

            // Game over condition
            if (player.position.y < camera.position.y - 15) {
                endGame();
            }

            // Infinite scroll
            if (player.position.y > lastStairGenerated * 0.5 - 20) { // Generate new stairs when player is 20 units from the top
                generateStairs(100, (lastStairGenerated + 1) * 0.5);
                lastStairGenerated += 100;

                // Remove old stairs
                const oldStairs = stairs.children.filter(s => s.position.y < player.position.y - 50);
                for (const stair of oldStairs) {
                    stairs.remove(stair);
                }
            }

            // Update score
            score = Math.max(score, Math.floor(player.position.y));
            document.getElementById('score').innerText = `Score: ${score}`;

            // Camera follow
            camera.position.x = player.position.x;
            camera.position.y = player.position.y + 5;
            camera.lookAt(player.position);

            renderer.render(scene, camera);

            wasOnGround = onGround;
        }

        function generateStairs(count, startY) {
            const stepHeight = 0.5;
            const stepRadius = 5;
            const stepWidth = 2;
            const angleStep = Math.PI / 8;

            for (let i = 0; i < count; i++) {
                const y = startY + i * stepHeight;
                const angle = i * angleStep;

                const geometry = new THREE.BoxGeometry(stepWidth, 0.2, stepWidth);
                let material;

                // Add special tiles
                const rand = Math.random();
                if (rand < 0.15 && y > 20) { // Spring tiles (green)
                    material = new THREE.MeshStandardMaterial({ color: 0x00ff88 });
                } else if (rand < 0.18 && y > 30) { // Speed boost tiles (yellow)
                    material = new THREE.MeshStandardMaterial({ color: 0xffff00 });
                } else if (rand < 0.21 && y > 40) { // Slow tiles (purple)
                    material = new THREE.MeshStandardMaterial({ color: 0x8800ff });
                } else if (rand < 0.24 && y > 50) { // Ice tiles (cyan)
                    material = new THREE.MeshStandardMaterial({ color: 0x00ffff });
                } else {
                    material = new THREE.MeshStandardMaterial({ color: 0x888888 });
                }

                const step = new THREE.Mesh(geometry, material);

                step.position.set(
                    Math.cos(angle) * stepRadius,
                    y,
                    Math.sin(angle) * stepRadius
                );
                step.rotation.y = -angle;
                stairs.add(step);
            }
        }

        function restartGame() {
            // Reset variables
            score = 0;
            gameOver = false;
            playerVelocity.set(0, 0, 0);
            player.position.set(5, 0.5, 0);
            player.visible = true;
            lastStairGenerated = 200;
            speedBoost = 0;
            slowEffect = 0;
            iceEffect = 0;

            // Reset UI
            document.getElementById('score').innerText = "Score: 0";
            document.getElementById('instructions').innerText = "A/D or ←/→: Move | Space: Jump | R: Restart";

            // Clear and regenerate stairs
            while(stairs.children.length > 0){
                stairs.remove(stairs.children[0]);
            }
            generateStairs(200, 0);

            // Remove particles
            if (particleSystem) {
                scene.remove(particleSystem);
                particleSystem = null;
            }
        }

        function endGame() {
            gameOver = true;
            document.getElementById('instructions').innerText = "Game Over! Press R to Restart";

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('spiralAscentHighScore', highScore);
                document.getElementById('highscore').innerText = `High Score: ${highScore}`;
            }

            createParticleSystem(player.position);
            player.visible = false; // Hide player on game over
            playSound('sawtooth', 110, 0.5);
        }

        function createParticleSystem(position) {
            const particleCount = 100;
            const particles = new THREE.BufferGeometry();
            const pMaterial = new THREE.PointsMaterial({
                color: 0xFFFFFF,
                size: 0.2,
                vertexColors: true,
                transparent: true,
                opacity: 0.7
            });

            const vertices = [];
            const colors = [];

            for (let i = 0; i < particleCount; i++) {
                const x = position.x + (Math.random() - 0.5) * 2;
                const y = position.y + (Math.random() - 0.5) * 2;
                const z = position.z + (Math.random() - 0.5) * 2;
                vertices.push(x, y, z);

                const color = new THREE.Color();
                color.setHSL(Math.random(), 1.0, 0.5);
                colors.push(color.r, color.g, color.b);
            }

            particles.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            particles.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            particleSystem = new THREE.Points(particles, pMaterial);
            scene.add(particleSystem);
        }

        init();
    </script>
</body>
</html>
